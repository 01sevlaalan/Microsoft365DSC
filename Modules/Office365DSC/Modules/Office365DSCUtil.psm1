$Locales = @(
    @{
        EnglishName = "Arabic (Algeria)"
        ID = "5121"
    },
    @{
        EnglishName = "Arabic (Bahrain)"
        ID = "15361"
    },
    @{
        EnglishName = "Arabic (Egypt)"
        ID = "3073"
    },
    @{
        EnglishName = "Arabic (Iraq)"
        ID = "2049"
    },
    @{
        EnglishName = "Arabic (Jordan)"
        ID = "11265"
    },
    @{
        EnglishName = "Arabic (Kuwait)"
        ID = "13313"
    },
    @{
        EnglishName = "Arabic (Lebanon)"
        ID = "12289"
    },
    @{
        EnglishName = "Arabic (Libya)"
        ID = "4097"
    },
    @{
        EnglishName = "Arabic (Morocco)"
        ID = "6145"
    },
    @{
        EnglishName = "Arabic (Oman)"
        ID = "8193"
    },
    @{
        EnglishName = "Arabic (Qatar)"
        ID = "16385"
    },
    @{
        EnglishName = "Arabic (Saudi Arabia)"
        ID = "1025"
    },
    @{
        EnglishName = "Arabic (Syria)"
        ID = "10241"
    },
    @{
        EnglishName = "Arabic (Tunisia)"
        ID = "7169"
    },
    @{
        EnglishName = "Arabic (U.A.E.)"
        ID = "14337"
    },
    @{
        EnglishName = "Arabic (Yemen)"
        ID = "9217"
    },
    @{
        EnglishName = "Basque"
        ID = "1069"
    },
    @{
        EnglishName = "Bulgarian"
        ID = "1026"
    },
    @{
        EnglishName = "Catalan"
        ID = "1027"
    },
    @{
        EnglishName = "Chinese (Hong Kong S.A.R)"
        ID = "3076"
    },
    @{
        EnglishName = "Chinese (Macau S.A.R)"
        ID = "5124"
    },
    @{
        EnglishName = "Chinese (People's Republic of China)"
        ID = "2052"
    },
    @{
        EnglishName = "Chinese (Singapore)"
        ID = "4100"
    },
    @{
        EnglishName = "Chinese (Taiwan)"
        ID = "1028"
    },
    @{
        EnglishName = "Croatian"
        ID = "1050"
    },
    @{
        EnglishName = "Czech"
        ID = "1029"
    },
    @{
        EnglishName = "Danish"
        ID = "1030"
    },
    @{
        EnglishName = "Dutch (Belgium)"
        ID = "2067"
    },
    @{
        EnglishName = "Dutch (Netherlands)"
        ID = "1043"
    },
    @{
        EnglishName = "English (Australia)"
        ID = "3081"
    },
    @{
        EnglishName = "English (Belize)"
        ID = "10249"
    },
    @{
        EnglishName = "English (Canada)"
        ID = "4105"
    },
    @{
        EnglishName = "English (Caribbean)"
        ID = "9225"
    },
    @{
        EnglishName = "English (Ireland)"
        ID = "6153"
    },
    @{
        EnglishName = "English (Jamaica)"
        ID = "8201"
    },
    @{
        EnglishName = "English (New Zealand)"
        ID = "5129"
    },
    @{
        EnglishName = "English (Republic of the Philippines)"
        ID = "13321"
    },
    @{
        EnglishName = "English (South Africa)"
        ID = "7177"
    },
    @{
        EnglishName = "English (Trinidad)"
        ID = "11273"
    },
    @{
        EnglishName = "English (United Kingdom)"
        ID = "2057"
    },
    @{
        EnglishName = "English (United States)"
        ID = "1033"
    },
    @{
        EnglishName = "English (Zimbabwe)"
        ID = "12297"
    },
    @{
        EnglishName = "Estonian"
        ID = "1061"
    },
    @{
        EnglishName = "Filipino (Philippines)"
        ID = "1124"
    },
    @{
        EnglishName = "Finnish"
        ID = "1035"
    },
    @{
        EnglishName = "French (Belgium)"
        ID = "2060"
    },
    @{
        EnglishName = "French (Canada)"
        ID = "3084"
    },
    @{
        EnglishName = "French (France)"
        ID = "1036"
    },
    @{
        EnglishName = "French (Luxembourg)"
        ID = "5132"
    },
    @{
        EnglishName = "French (Principality of Monaco)"
        ID = "6156"
    },
    @{
        EnglishName = "French (Switzerland)"
        ID = "4108"
    },
    @{
        EnglishName = "German (Austria)"
        ID = "3079"
    },
    @{
        EnglishName = "German (Germany)"
        ID = "1031"
    },
    @{
        EnglishName = "German (Liechtenstein)"
        ID = "5127"
    },
    @{
        EnglishName = "German (Luxembourg)"
        ID = "4103"
    },
    @{
        EnglishName = "German (Switzerland)"
        ID = "2055"
    },
    @{
        EnglishName = "Greek"
        ID = "1032"
    },
    @{
        EnglishName = "Hebrew"
        ID = "1037"
    },
    @{
        EnglishName = "Hindi"
        ID = "1081"
    },
    @{
        EnglishName = "Hungarian"
        ID = "1038"
    },
    @{
        EnglishName = "Icelandic"
        ID = "1039"
    },
    @{
        EnglishName = "Indonesian"
        ID = "1057"
    },
    @{
        EnglishName = "Italian (Italy)"
        ID = "1040"
    },
    @{
        EnglishName = "Italian (Switzerland)"
        ID = "2064"
    },
    @{
        EnglishName = "Japanese"
        ID = "1041"
    },
    @{
        EnglishName = "Kazakh"
        ID = "1087"
    },
    @{
        EnglishName = "Korean"
        ID = "1042"
    },
    @{
        EnglishName = "Latvian"
        ID = "1062"
    },
    @{
        EnglishName = "Lithuanian"
        ID = "1063"
    },
    @{
        EnglishName = "Malay"
        ID = "1086"
    },
    @{
        EnglishName = "Norwegian (Bokmal)"
        ID = "1044"
    },
    @{
        EnglishName = "Persian"
        ID = "1065"
    },
    @{
        EnglishName = "Polish"
        ID = "1045"
    },
    @{
        EnglishName = "Portuguese (Brazil)"
        ID = "1046"
    },
    @{
        EnglishName = "Portuguese (Portugal)"
        ID = "2070"
    },
    @{
        EnglishName = "Romanian"
        ID = "1048"
    },
    @{
        EnglishName = "Russian"
        ID = "1049"
    },
    @{
        EnglishName = "Serbian (Cyrillic)"
        ID = "3098"
    },
    @{
        EnglishName = "Serbian (Latin)"
        ID = "2074"
    },
    @{
        EnglishName = "Slovak"
        ID = "1051"
    },
    @{
        EnglishName = "Slovenian"
        ID = "1060"
    },
    @{
        EnglishName = "Spanish (Argentina)"
        ID = "11274"
    },
    @{
        EnglishName = "Spanish (Bolivia)"
        ID = "16394"
    },
    @{
        EnglishName = "Spanish (Chile)"
        ID = "13322"
    },
    @{
        EnglishName = "Spanish (Colombia)"
        ID = "9226"
    },
    @{
        EnglishName = "Spanish (Costa Rica)"
        ID = "5130"
    },
    @{
        EnglishName = "Spanish (Dominican Republic)"
        ID = "7178"
    },
    @{
        EnglishName = "Spanish (Ecuador)"
        ID = "12298"
    },
    @{
        EnglishName = "Spanish (El Salvador)"
        ID = "17418"
    },
    @{
        EnglishName = "Spanish (Guatemala)"
        ID = "4106"
    },
    @{
        EnglishName = "Spanish (Honduras)"
        ID = "18442"
    },
    @{
        EnglishName = "Spanish (Mexico)"
        ID = "2058"
    },
    @{
        EnglishName = "Spanish (Nicaragua)"
        ID = "19466"
    },
    @{
        EnglishName = "Spanish (Panama)"
        ID = "6154"
    },
    @{
        EnglishName = "Spanish (Paraguay)"
        ID = "15370"
    },
    @{
        EnglishName = "Spanish (Peru)"
        ID = "10250"
    },
    @{
        EnglishName = "Spanish (Puerto Rico)"
        ID = "20490"
    },
    @{
        EnglishName = "Spanish (International Sort)"
        ID = "3082"
    },
    @{
        EnglishName = "Spanish (Traditional Sort)"
        ID = "1034"
    },
    @{
        EnglishName = "Spanish (Uruguay)"
        ID = "14346"
    },
    @{
        EnglishName = "Spanish (Venezuela)"
        ID = "8202"
    },
    @{
        EnglishName = "Swedish (Finland)"
        ID = "2077"
    },
    @{
        EnglishName = "Swedish (Sweden)"
        ID = "1053"
    },
    @{
        EnglishName = "Thai"
        ID = "1054"
    },
    @{
        EnglishName = "Turkish"
        ID = "1055"
    },
    @{
        EnglishName = "Ukrainian"
        ID = "1058"
    },
    @{
        EnglishName = "Urdu"
        ID = "1056"
    },
    @{
        EnglishName = "Vietnamese"
        ID = "1066"
    }
)

$TimeZones = @(
    @{
        ID = "000"
        EnglishName = "Dateline Standard Time"
        EnglishDescription = "(GMT-12:00) International Date Line West"
    },
    @{
        ID = "001"
        EnglishName = "Samoa Standard Time"
        EnglishDescription = "(GMT-11:00) Midway Island, Samoa"
    },
    @{
        ID = "002"
        EnglishName = "Hawaiian Standard Time"
        EnglishDescription = "(GMT-10:00) Hawaii"
    },
    @{
        ID = "003"
        EnglishName = "Alaskan Standard Time"
        EnglishDescription = "(GMT-09:00) Alaska"
    },
    @{
        ID = "004"
        EnglishName = "Pacific Standard Time"
        EnglishDescription = "(GMT-08:00) Pacific Time (US and Canada); Tijuana"
    },
    @{
        ID = "010"
        EnglishName = "Mountain Standard Time"
        EnglishDescription = "(GMT-07:00) Mountain Time (US and Canada)"
    },
    @{
        ID = "013"
        EnglishName = "Mexico Standard Time 2"
        EnglishDescription = "(GMT-07:00) Chihuahua, La Paz, Mazatlan"
    },
    @{
        ID = "015"
        EnglishName = "U.S. Mountain Standard Time"
        EnglishDescription = "(GMT-07:00) Arizona"
    },
    @{
        ID = "020"
        EnglishName = "Central Standard Time"
        EnglishDescription = "(GMT-06:00) Central Time (US and Canada"
    },
    @{
        ID = "025"
        EnglishName = "Canada Central Standard Time"
        EnglishDescription = "(GMT-06:00) Saskatchewan"
    },
    @{
        ID = "030"
        EnglishName = "Mexico Standard Time"
        EnglishDescription = "(GMT-06:00) Guadalajara, Mexico City, Monterrey"
    },
    @{
        ID = "033"
        EnglishName = "Central America Standard Time"
        EnglishDescription = "(GMT-06:00) Central America"
    },
    @{
        ID = "035"
        EnglishName = "Eastern Standard Time"
        EnglishDescription = "(GMT-05:00) Eastern Time (US and Canada)"
    },
    @{
        ID = "040"
        EnglishName = "U.S. Eastern Standard Time"
        EnglishDescription = "(GMT-05:00) Indiana (East)"
    },
    @{
        ID = "045"
        EnglishName = "S.A. Pacific Standard Time"
        EnglishDescription = "(GMT-05:00) Bogota, Lima, Quito"
    },
    @{
        ID = "050"
        EnglishName = "Atlantic Standard Time"
        EnglishDescription = "(GMT-04:00) Atlantic Time (Canada)"
    },
    @{
        ID = "055"
        EnglishName = "S.A. Western Standard Time"
        EnglishDescription = "(GMT-04:00) Caracas, La Paz"
    },
    @{
        ID = "056"
        EnglishName = "Pacific S.A. Standard Time"
        EnglishDescription = "(GMT-04:00) Santiago"
    },
    @{
        ID = "060"
        EnglishName = "Newfoundland and Labrador Standard Time"
        EnglishDescription = "(GMT-03:30) Newfoundland and Labrador"
    },
    @{
        ID = "065"
        EnglishName = "E. South America Standard Time"
        EnglishDescription = "(GMT-03:00) Brasilia"
    },
    @{
        ID = "070"
        EnglishName = "S.A. Eastern Standard Time"
        EnglishDescription = "(GMT-03:00) Buenos Aires, Georgetown"
    },
    @{
        ID = "073"
        EnglishName = "Greenland Standard Time"
        EnglishDescription = "(GMT-03:00) Greenland"
    },
    @{
        ID = "075"
        EnglishName = "Mid-Atlantic Standard Time"
        EnglishDescription = "(GMT-02:00) Mid-Atlantic"
    },
    @{
        ID = "080"
        EnglishName = "Azores Standard Time"
        EnglishDescription = "(GMT-01:00) Azores"
    },
    @{
        ID = "083"
        EnglishName = "Cape Verde Standard Time"
        EnglishDescription = "(GMT-01:00) Cape Verde Islands"
    },
    @{
        ID = "085"
        EnglishName = "GMT Standard Time"
        EnglishDescription = "(GMT) Greenwich Mean Time: Dublin, Edinburgh, Lisbon, London"
    },
    @{
        ID = "090"
        EnglishName = "Greenwich Standard Time"
        EnglishDescription = "(GMT) Casablanca, Monrovia"
    },
    @{
        ID = "095"
        EnglishName = "Central Europe Standard Time"
        EnglishDescription = "(GMT+01:00) Belgrade, Bratislava, Budapest, Ljubljana, Prague"
    },
    @{
        ID = "100"
        EnglishName = "Central European Standard Time"
        EnglishDescription = "(GMT+01:00) Sarajevo, Skopje, Warsaw, Zagreb"
    },
    @{
        ID = "105"
        EnglishName = "Romance Standard Time"
        EnglishDescription = "(GMT+01:00) Brussels, Copenhagen, Madrid, Paris"
    },
    @{
        ID = "110"
        EnglishName = "W. Europe Standard Time"
        EnglishDescription = "(GMT+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna"
    },
    @{
        ID = "113"
        EnglishName = "W. Central Africa Standard Time"
        EnglishDescription = "(GMT+01:00) West Central Africa"
    },
    @{
        ID = "115"
        EnglishName = "E. Europe Standard Time"
        EnglishDescription = "(GMT+02:00) Bucharest"
    },
    @{
        ID = "120"
        EnglishName = "Egypt Standard Time"
        EnglishDescription = "(GMT+02:00) Cairo"
    },
    @{
        ID = "125"
        EnglishName = "FLE Standard Time"
        EnglishDescription = "(GMT+02:00) Helsinki, Kiev, Riga, Sofia, Tallinn, Vilnius"
    },
    @{
        ID = "130"
        EnglishName = "GTB Standard Time"
        EnglishDescription = "(GMT+02:00) Athens, Istanbul, Minsk"
    },
    @{
        ID = "135"
        EnglishName = "Israel Standard Time"
        EnglishDescription = "(GMT+02:00) Jerusalem"
    },
    @{
        ID = "140"
        EnglishName = "South Africa Standard Time"
        EnglishDescription = "(GMT+02:00) Harare, Pretoria"
    },
    @{
        ID = "145"
        EnglishName = "Russian Standard Time"
        EnglishDescription = "(GMT+03:00) Moscow, St. Petersburg, Volgograd"
    },
    @{
        ID = "150"
        EnglishName = "Arab Standard Time"
        EnglishDescription = "(GMT+03:00) Kuwait, Riyadh"
    },
    @{
        ID = "155"
        EnglishName = "E. Africa Standard Time"
        EnglishDescription = "(GMT+03:00) Nairobi"
    },
    @{
        ID = "158"
        EnglishName = "Arabic Standard Time"
        EnglishDescription = "(GMT+03:00) Baghdad"
    },
    @{
        ID = "160"
        EnglishName = "Iran Standard Time"
        EnglishDescription = "(GMT+03:30) Tehran"
    },
    @{
        ID = "165"
        EnglishName = "Arabian Standard Time"
        EnglishDescription = "(GMT+04:00) Abu Dhabi, Muscat"
    },
    @{
        ID = "170"
        EnglishName = "Caucasus Standard Time"
        EnglishDescription = "(GMT+04:00) Baku, Tbilisi, Yerevan"
    },
    @{
        ID = "175"
        EnglishName = "Transitional Islamic State of Afghanistan Standard Time"
        EnglishDescription = "(GMT+04:30) Kabul"
    },
    @{
        ID = "180"
        EnglishName = "Ekaterinburg Standard Time"
        EnglishDescription = "(GMT+05:00) Ekaterinburg"
    },
    @{
        ID = "185"
        EnglishName = "West Asia Standard Time"
        EnglishDescription = "(GMT+05:00) Islamabad, Karachi, Tashkent"
    },
    @{
        ID = "190"
        EnglishName = "India Standard Time"
        EnglishDescription = "(GMT+05:30) Chennai, Kolkata, Mumbai, New Delhi"
    },
    @{
        ID = "193"
        EnglishName = "Nepal Standard Time"
        EnglishDescription = "(GMT+05:45) Kathmandu"
    },
    @{
        ID = "195"
        EnglishName = "Central Asia Standard Time"
        EnglishDescription = "(GMT+06:00) Astana, Dhaka"
    },
    @{
        ID = "200"
        EnglishName = "Sri Lanka Standard Time"
        EnglishDescription = "(GMT+06:00) Sri Jayawardenepura"
    },
    @{
        ID = "201"
        EnglishName = "N. Central Asia Standard Time"
        EnglishDescription = "(GMT+06:00) Almaty, Novosibirsk"
    },
    @{
        ID = "203"
        EnglishName = "Myanmar Standard Time"
        EnglishDescription = "(GMT+06:30) Yangon Rangoon"
    },
    @{
        ID = "205"
        EnglishName = "S.E. Asia Standard Time"
        EnglishDescription = "(GMT+07:00) Bangkok, Hanoi, Jakarta"
    },
    @{
        ID = "207"
        EnglishName = "North Asia Standard Time"
        EnglishDescription = "(GMT+07:00) Krasnoyarsk"
    },
    @{
        ID = "210"
        EnglishName = "China Standard Time"
        EnglishDescription = "(GMT+08:00) Beijing, Chongqing, Hong Kong SAR, Urumqi"
    },
    @{
        ID = "215"
        EnglishName = "Singapore Standard Time"
        EnglishDescription = "(GMT+08:00) Kuala Lumpur, Singapore"
    },
    @{
        ID = "220"
        EnglishName = "Taipei Standard Time"
        EnglishDescription = "(GMT+08:00) Taipei"
    },
    @{
        ID = "225"
        EnglishName = "W. Australia Standard Time"
        EnglishDescription = "(GMT+08:00) Perth"
    },
    @{
        ID = "227"
        EnglishName = "North Asia East Standard Time"
        EnglishDescription = "(GMT+08:00) Irkutsk, Ulaanbaatar"
    },
    @{
        ID = "230"
        EnglishName = "Korea Standard Time"
        EnglishDescription = "(GMT+09:00) Seoul"
    },
    @{
        ID = "235"
        EnglishName = "Tokyo Standard Time"
        EnglishDescription = "(GMT+09:00) Osaka, Sapporo, Tokyo"
    },
    @{
        ID = "240"
        EnglishName = "Yakutsk Standard Time"
        EnglishDescription = "(GMT+09:00) Yakutsk"
    },
    @{
        ID = "245"
        EnglishName = "A.U.S. Central Standard Time"
        EnglishDescription = "(GMT+09:30) Darwin"
    },
    @{
        ID = "250"
        EnglishName = "Cen. Australia Standard Time"
        EnglishDescription = "(GMT+09:30) Adelaide"
    },
    @{
        ID = "255"
        EnglishName = "A.U.S. Eastern Standard Time"
        EnglishDescription = "(GMT+10:00) Canberra, Melbourne, Sydney"
    },
    @{
        ID = "260"
        EnglishName = "E. Australia Standard Time"
        EnglishDescription = "(GMT+10:00) Brisbane"
    },
    @{
        ID = "265"
        EnglishName = "Tasmania Standard Time"
        EnglishDescription = "(GMT+10:00) Hobart"
    },
    @{
        ID = "270"
        EnglishName = "Vladivostok Standard Time"
        EnglishDescription = "(GMT+10:00) Vladivostok"
    },
    @{
        ID = "275"
        EnglishName = "West Pacific Standard Time"
        EnglishDescription = "(GMT+10:00) Guam, Port Moresby"
    },
    @{
        ID = "280"
        EnglishName = "Central Pacific Standard Time"
        EnglishDescription = "(GMT+11:00) Magadan, Solomon Islands, New Caledonia"
    },
    @{
        ID = "285"
        EnglishName = "Fiji Islands Standard Time"
        EnglishDescription = "(GMT+12:00) Fiji Islands, Kamchatka, Marshall Islands"
    },
    @{
        ID = "290"
        EnglishName = "New Zealand Standard Time"
        EnglishDescription = "(GMT+12:00) Auckland, Wellington"
    },
    @{
        ID = "300"
        EnglishName = "Tonga Standard Time"
        EnglishDescription = "(GMT+13:00) Nuku’alofa"
    }
)

function Get-LocaleIDFromName
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $Name
    )

    $LocaleObject = $Locales | Where-Object { $_.EnglishName -eq $Name }

    if ($null -eq $LocaleObject)
    {
        throw "The specified Locale name {$($Name)} is not valid"
    }
    return $LocaleObject.ID
}

function Get-LocaleNameFromID
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $ID
    )

    $LocaleObject = $Locales | Where-Object { $_.ID -eq $ID }

    if ($null -eq $LocaleObject)
    {
        throw "The specified Locale with ID {$($ID)} is not valid"
    }
    return $LocaleObject.EnglishName
}

function Get-TimeZoneNameFromID
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $ID
    )

    $TimezoneObject = $Timezones | Where-Object { $_.ID -eq $ID }

    if ($null -eq $TimezoneObject)
    {
        throw "The specified Timzone with ID {$($ID)} is not valid"
    }
    return $TimezoneObject.EnglishName
}
function Get-TimeZoneIDFromName
{
    [CmdletBinding()]
    [OutputType([String])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $Name
    )

    $TimezoneObject = $Timezones | Where-Object { $_.EnglishName -eq $Name }

    if ($null -eq $TimezoneObject)
    {
        throw "The specified Timzone {$($Name)} is not valid"
    }
    return $TimezoneObject.ID
}

function Test-SPOServiceConnection
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $SPOCentralAdminUrl,

        [Parameter(Mandatory = $true)] 
        [System.Management.Automation.PSCredential] 
        $GlobalAdminAccount
    )
    Write-Verbose "Verifying the LCM connection state to SharePoint Online"
    Connect-SPOService -Url $SPOCentralAdminUrl -Credential $GlobalAdminAccount
}

function Test-PnPOnlineConnection
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)]
        [System.String]
        $SPOCentralAdminUrl,

        [Parameter(Mandatory = $true)] 
        [System.Management.Automation.PSCredential] 
        $GlobalAdminAccount
    )
    Write-Verbose "Verifying the LCM connection state to SharePoint Online with PnP"
    Connect-PnPOnline -Url $SPOCentralAdminUrl -Credentials $GlobalAdminAccount
}

function Test-O365ServiceConnection
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)] 
        [System.Management.Automation.PSCredential] 
        $GlobalAdminAccount
    )    
    Write-Verbose "Verifying the LCM connection state to Microsoft Azure Active Directory Services"
    Connect-AzureAD -Credential $GlobalAdminAccount
}
function Test-TeamsServiceConnection {
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param
    (
        [Parameter(Mandatory = $true)] 
        [System.Management.Automation.PSCredential] 
        $GlobalAdminAccount
    )    
    Write-Verbose "Verifying the LCM connection state to Teams"
    Connect-MicrosoftTeams -Credential $GlobalAdminAccount | Out-Null
}

function Invoke-ExoCommand
{
    [CmdletBinding()]
    param
    (
        [Parameter()]
        [System.Management.Automation.PSCredential]
        $GlobalAdminAccount,
    
        [Parameter()]
        [Object[]]
        $Arguments,
    
        [Parameter(Mandatory = $true)]
        [ScriptBlock]
        $ScriptBlock
    )
    $VerbosePreference = 'Continue'
    $invokeArgs = @{
        ScriptBlock = [ScriptBlock]::Create($ScriptBlock.ToString())
    }
    if ($null -ne $Arguments) {
        $invokeArgs.Add("ArgumentList", $Arguments)
    }

    Write-Verbose "Verifying the LCM connection state to Exchange Online"
    $AssemblyPath = Join-Path -Path $PSScriptRoot `
        -ChildPath "..\Dependencies\Microsoft.Exchange.Management.ExoPowershellModule.dll" `
        -Resolve
    $AADAssemblyPath = Join-Path -Path $PSScriptRoot `
        -ChildPath "..\Dependencies\Microsoft.IdentityModel.Clients.ActiveDirectory.dll" `
        -Resolve

    $ScriptPath = Join-Path -Path $PSScriptRoot `
        -ChildPath "..\Dependencies\CreateExoPSSession.ps1" `
        -Resolve

    Import-Module $AssemblyPath
    [Reflection.Assembly]::LoadFile($AADAssemblyPath)
    .$ScriptPath

    # Somehow, every now and then, the first connection attempt will get an invalid Shell Id. Calling the function a second
    # time fixes the issue.
    try
    {
        if (!$Global:ExoPSSessionConnected)
        {
            Connect-ExoPSSession -Credential $GlobalAdminAccount -ErrorAction SilentlyContinue
            $Global:ExoPSSessionConnected = $true
        }
    }
    catch {
        # Check to see if we received a payload error, and if so, wait for the requested period of time before proceeding
        # with the next call.
        $stringToFind = "you have exceeded your budget to create runspace. Please wait for "
        if ($Error) {
            $position = $Error[0].ErrorDetails.Message.IndexOf($stringToFind)

            if ($position -ge 0) {
                $beginning = $position + $stringToFind.Length
                $nextSpace = $Error[0].ErrorDetails.Message.IndexOf(" ", $beginning)

                [int]$timeToWaitInSeconds = $Error[0].ErrorDetails.Message.Substring($beginning, $nextSpace - $beginning)

                Write-Verbose "Detected an exceeded payload against the remote server. Waiting for $($timeToWaitInSeconds) seconds."
                Start-Sleep -Seconds $timeToWaitInSeconds
            }
        }
        Connect-ExoPSSession -Credential $GlobalAdminAccount -ErrorAction SilentlyContinue
        $Global:ExoPSSessionConnected = $true
    }

    try
    {
        $result = Invoke-Command @invokeArgs -Verbose
    }
    catch
    {
        Connect-ExoPSSession -Credential $GlobalAdminAccount -ErrorAction SilentlyContinue
        $Global:ExoPSSessionConnected = $true
        $result = Invoke-Command @invokeArgs -Verbose
    }
    
    return $result
}

function Test-Office365DSCParameterState {
    [CmdletBinding()]
    param
    (
        [Parameter(Mandatory = $true, Position = 1)]
        [HashTable]
        $CurrentValues,

        [Parameter(Mandatory = $true, Position = 2)]
        [Object]
        $DesiredValues,

        [Parameter(, Position = 3)]
        [Array]
        $ValuesToCheck
    )

    $returnValue = $true

    if (($DesiredValues.GetType().Name -ne "HashTable") `
            -and ($DesiredValues.GetType().Name -ne "CimInstance") `
            -and ($DesiredValues.GetType().Name -ne "PSBoundParametersDictionary")) {
        throw ("Property 'DesiredValues' in Test-SPDscParameterState must be either a " + `
                "Hashtable or CimInstance. Type detected was $($DesiredValues.GetType().Name)")
    }

    if (($DesiredValues.GetType().Name -eq "CimInstance") -and ($null -eq $ValuesToCheck)) {
        throw ("If 'DesiredValues' is a CimInstance then property 'ValuesToCheck' must contain " + `
                "a value")
    }

    if (($null -eq $ValuesToCheck) -or ($ValuesToCheck.Count -lt 1)) {
        $KeyList = $DesiredValues.Keys
    }
    else {
        $KeyList = $ValuesToCheck
    }

    $KeyList | ForEach-Object -Process {
        if (($_ -ne "Verbose") -and ($_ -ne "InstallAccount")) {
            if (($CurrentValues.ContainsKey($_) -eq $false) `
                    -or ($CurrentValues.$_ -ne $DesiredValues.$_) `
                    -or (($DesiredValues.ContainsKey($_) -eq $true) -and ($null -ne $DesiredValues.$_ -and $DesiredValues.$_.GetType().IsArray))) {
                if ($DesiredValues.GetType().Name -eq "HashTable" -or `
                        $DesiredValues.GetType().Name -eq "PSBoundParametersDictionary") {
                    $CheckDesiredValue = $DesiredValues.ContainsKey($_)
                }
                else {
                    $CheckDesiredValue = Test-SPDSCObjectHasProperty -Object $DesiredValues -PropertyName $_
                }

                if ($CheckDesiredValue) {
                    $desiredType = $DesiredValues.$_.GetType()
                    $fieldName = $_
                    if ($desiredType.IsArray -eq $true) {
                        if (($CurrentValues.ContainsKey($fieldName) -eq $false) `
                                -or ($null -eq $CurrentValues.$fieldName)) {
                            Write-Verbose -Message ("Expected to find an array value for " + `
                                    "property $fieldName in the current " + `
                                    "values, but it was either not present or " + `
                                    "was null. This has caused the test method " + `
                                    "to return false.")
                            $returnValue = $false
                        }
                        else {
                            $arrayCompare = Compare-Object -ReferenceObject $CurrentValues.$fieldName `
                                -DifferenceObject $DesiredValues.$fieldName
                            if ($null -ne $arrayCompare) {
                                Write-Verbose -Message ("Found an array for property $fieldName " + `
                                        "in the current values, but this array " + `
                                        "does not match the desired state. " + `
                                        "Details of the changes are below.")
                                $arrayCompare | ForEach-Object -Process {
                                    Write-Verbose -Message "$($_.InputObject) - $($_.SideIndicator)"
                                }
                                $returnValue = $false
                            }
                        }
                    }
                    else {
                        switch ($desiredType.Name) {
                            "String" {
                                if ([string]::IsNullOrEmpty($CurrentValues.$fieldName) `
                                        -and [string]::IsNullOrEmpty($DesiredValues.$fieldName))
                                {}
                                else {
                                    Write-Verbose -Message ("String value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Int32" {
                                if (($DesiredValues.$fieldName -eq 0) `
                                        -and ($null -eq $CurrentValues.$fieldName))
                                {}
                                else {
                                    Write-Verbose -Message ("Int32 value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Int16" {
                                if (($DesiredValues.$fieldName -eq 0) `
                                        -and ($null -eq $CurrentValues.$fieldName))
                                {}
                                else {
                                    Write-Verbose -Message ("Int16 value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Boolean" {
                                if ($CurrentValues.$fieldName -ne $DesiredValues.$fieldName) {
                                    Write-Verbose -Message ("Boolean value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            "Single" {
                                if (($DesiredValues.$fieldName -eq 0) `
                                        -and ($null -eq $CurrentValues.$fieldName))
                                {}
                                else {
                                    Write-Verbose -Message ("Single value for property " + `
                                            "$fieldName does not match. " + `
                                            "Current state is " + `
                                            "'$($CurrentValues.$fieldName)' " + `
                                            "and desired state is " + `
                                            "'$($DesiredValues.$fieldName)'")
                                    $returnValue = $false
                                }
                            }
                            default {
                                Write-Verbose -Message ("Unable to compare property $fieldName " + `
                                        "as the type ($($desiredType.Name)) is " + `
                                        "not handled by the " + `
                                        "Test-SPDscParameterState cmdlet")
                                $returnValue = $false
                            }
                        }
                    }
                }
            }
        }
    }
    return $returnValue
}

function Get-UsersLicences {
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param(
        [Parameter(Mandatory = $true)] 
        [System.Management.Automation.PSCredential] 
        $GlobalAdminAccount
    )
    Test-O365ServiceConnection -GlobalAdminAccount $GlobalAdminAccount
    Write-Verbose "Store all users licences information in Global Variable for futur usage."
    #Store information to be able to check later if the users is correctly licences for features.
    if ($null -eq $Global:UsersLicences)
    {
        $Global:UsersLicences = Get-MsolUser -All  | Select-Object UserPrincipalName, isLicensed, Licenses
    }
    Return $Global:UsersLicences
}

<# This is the main Office365DSC.Reverse function that extracts the DSC configuration from an existing
   Office 365 Tenant. #>
function Export-O365Configuration
{
    [CmdletBinding()]
    [OutputType([System.Collections.Hashtable])]
    param(
        [Parameter(Mandatory = $true)] 
        [System.Management.Automation.PSCredential] 
        $GlobalAdminAccount
    )
    #$VerbosePreference = 'Continue'
    $AzureAutomation = $false
    $DSCContent = "Configuration O365TenantConfig `r`n{`r`n"
    $DSCContent += "    Import-DSCResource -ModuleName Office365DSC`r`n`r`n"
    $DSCContent += "    <# Credentials #>`r`n"
    $DSCContent += "    Node localhost`r`n"
    $DSCContent += "    {`r`n"

    # Add the GlobalAdminAccount to the Credentials List
    Save-Credentials -UserName $GlobalAdminAccount.UserName

    #region "EXOMailboxSettings"
    $EXOMailboxSettingsModulePath = Join-Path -Path $PSScriptRoot `
                                              -ChildPath "..\DSCResources\MSFT_EXOMailboxSettings\MSFT_EXOMailboxSettings.psm1" `
                                              -Resolve

    Import-Module $EXOMailboxSettingsModulePath
    $mailboxes = Invoke-ExoCommand -GlobalAdminAccount $GlobalAdminAccount `
                                   -ScriptBlock {
        Get-Mailbox
    }

    foreach ($mailbox in $mailboxes)
    {
        $mailboxName = $mailbox.Name
        if ($mailboxName)
        {
            $DSCContent += Export-TargetResource -DisplayName $mailboxName -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "EXOMailTips"
    $OrgConfig = Invoke-ExoCommand -GlobalAdminAccount $GlobalAdminAccount `
                                    -ScriptBlock {
        Get-OrganizationConfig
    }

    $organizationName = $OrgConfig.Name
    Add-ConfigurationDataEntry -Node "localhost" `
                               -Key "OrganizationName" `
                               -Value $organizationName `
                               -Description "Name of the Organization"

    $EXOMailTipsModulePath = Join-Path -Path $PSScriptRoot `
                                       -ChildPath "..\DSCResources\MSFT_EXOMailTips\MSFT_EXOMailTips.psm1" `
                                       -Resolve

    Import-Module $EXOMailTipsModulePath
    $DSCContent += Export-TargetResource -Organization $organizationName -GlobalAdminAccount $GlobalAdminAccount
    #endregion

    #region "EXOSharedMailbox"
    $EXOSharedMailboxModulePath = Join-Path -Path $PSScriptRoot `
                                            -ChildPath "..\DSCResources\MSFT_EXOSharedMailbox\MSFT_EXOSharedMailbox.psm1" `
                                            -Resolve

    Import-Module $EXOSharedMailboxModulePath
    $mailboxes = Invoke-ExoCommand -GlobalAdminAccount $GlobalAdminAccount `
                                   -ScriptBlock {
        Get-Mailbox
    }
    $mailboxes = $mailboxes | Where-Object {$_.RecipientTypeDetails -eq "SharedMailbox"}

    foreach ($mailbox in $mailboxes)
    {
        $mailboxName = $mailbox.Name
        if ($mailboxName)
        {
            $DSCContent += Export-TargetResource -DisplayName $mailboxName -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "O365Group"
    $O365GroupModulePath = Join-Path -Path $PSScriptRoot `
                                     -ChildPath "..\DSCResources\MSFT_O365Group\MSFT_O365Group.psm1" `
                                     -Resolve

    Import-Module $O365GroupModulePath

    # Security Groups
    Test-O365ServiceConnection -GlobalAdminAccount $GlobalAdminAccount
    $securityGroups = Get-AzureAdGroup | Where-Object {$_.SecurityEnabled -eq $true}

    foreach ($securityGroup in $securityGroups)
    {
        $securityGroupDisplayName = $securityGroup.DisplayName
        if ($securityGroupDisplayName)
        {
            $DSCContent += Export-TargetResource -DisplayName $securityGroupDisplayName `
                                                 -GroupType "Security" `
                                                 -GlobalAdminAccount $GlobalAdminAccount
        }
    }

    $securityGroups = Get-AzureAdGroup | Where-Object {$_.SecurityEnabled -eq $true}

    # Other Groups
    $groups = Invoke-ExoCommand -GlobalAdminAccount $GlobalAdminAccount `
                                -ScriptBlock {
        Get-Group
    }
    $groups = $groups | Where-Object { `
        $_.RecipientType -eq "MailUniversalDistributionGroup" `
        -or $_.RecipientType -eq "MailUniversalSecurityGroup" `
    }
    foreach ($group in $groups)
    {
        $groupName = $group.DisplayName
        if ($groupName)
        {
            $groupType = "DistributionList"
            if ($group.RecipientTypeDetails -eq "GroupMailbox")
            {
                $groupType = "Office365"
            }
            elseif ($group.RecipientTypeDetails -eq "MailUniversalSecurityGroup")
            {
                $groupType = "MailEnabledSecurity"
            }
            $DSCContent += Export-TargetResource -DisplayName $groupName `
                                                 -GroupType $groupType `
                                                 -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "O365User"
    $O365UserModulePath = Join-Path -Path $PSScriptRoot `
                                    -ChildPath "..\DSCResources\MSFT_O365USer\MSFT_O365USer.psm1" `
                                    -Resolve

    Import-Module $O365UserModulePath
    Test-O365ServiceConnection -GlobalAdminAccount $GlobalAdminAccount

    $users = Get-AzureADUser

    foreach ($user in $users)
    {
        $userUPN = $user.UserPrincipalName
        if ($userUPN)
        {
            $DSCContent += Export-TargetResource -UserPrincipalName $userUPN -GlobalAdminAccount $GlobalAdminAccount
        }
    }
    #endregion

    #region "ODSettings"
    $ODSettingsModulePath = Join-Path -Path $PSScriptRoot `
                                      -ChildPath "..\DSCResources\MSFT_ODSettings\MSFT_ODSettings.psm1" `
                                      -Resolve

    Import-Module $ODSettingsModulePath

    # Obtain central administration url from a User Principal Name
    $centralAdminUrl = $null
    if ($users.Count -gt 0)
    {
        $tenantParts = $users[0].UserPrincipalName.Split('@')
        if ($tenantParts.Length -gt 0)
        {
            $tenantName = $tenantParts[1].Split(".")[0]
            $centralAdminUrl = "https://" + $tenantName + "-admin.sharepoint.com"
        }
    }

    if ($centralAdminUrl)
    {
        $DSCContent += Export-TargetResource -CentralAdminUrl $centralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
    }
    #endregion

    #region "SPOSearchManagedProperty"
    $SPOSearchManagedPropertyModulePath = Join-Path -Path $PSScriptRoot `
                                                    -ChildPath "..\DSCResources\MSFT_SPOSearchManagedProperty\MSFT_SPOSearchManagedProperty.psm1" `
                                                    -Resolve

    Import-Module $SPOSearchManagedPropertyModulePath
    Write-Verbose "Getting here to PnP"
    Test-PnPOnlineConnection -SPOCentralAdminUrl $CentralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
    $SearchConfig = [Xml] (Get-PnPSearchConfiguration -Scope Subscription)
    $properties =  $SearchConfig.SearchConfigurationSettings.SearchSchemaConfigurationSettings.Mappings.dictionary.KeyValueOfstringMappingInfoy6h3NzC8

    foreach ($property in $properties)
    {
        $DSCContent += Export-TargetResource -Name $property.Value.Name `
                                             -Type $property.Value.ManagedType `
                                             -CentralAdminUrl $centralAdminUrl `
                                             -GlobalAdminAccount $GlobalAdminAccount
    }
    #endregion

    #region "SPOSite"
    $SPOSiteModulePath = Join-Path -Path $PSScriptRoot `
                                    -ChildPath "..\DSCResources\MSFT_SPOSite\MSFT_SPOSite.psm1" `
                                    -Resolve

    Import-Module $SPOSiteModulePath

    Test-SPOServiceConnection -SPOCentralAdminUrl $CentralAdminUrl -GlobalAdminAccount $GlobalAdminAccount
    $sites = Get-SPOSite

    foreach ($site in $sites)
    {
        $DSCContent += Export-TargetResource -Url $site.Url `
                                             -CentralAdminUrl $centralAdminUrl `
                                             -GlobalAdminAccount $GlobalAdminAccount
    }
    #endregion

    # Close the Node and Configuration declarations
    $DSCContent += "    }`r`n"
    $DSCContent += "}`r`n"

    #region Add the Prompt for Required Credentials at the top of the Configuration
    $credsContent = ""
    foreach ($credential in $Global:CredsRepo)
    {
        if (!$credential.ToLower().StartsWith("builtin"))
        {
            if (!$AzureAutomation)
            {
                $credsContent += "    " + (Resolve-Credentials $credential) + " = Get-Credential -UserName `"" + $credential + "`" -Message `"Please provide credentials`"`r`n"
            }
            else
            {
                $resolvedName = (Resolve-Credentials $credential)
                $credsContent += "    " + $resolvedName + " = Get-AutomationPSCredential -Name " + ($resolvedName.Replace("$", "")) + "`r`n"
            }
        }
    }
    $credsContent += "`r`n"
    $startPosition = $DSCContent.IndexOf("<# Credentials #>") + 19
    $DSCContent = $DSCContent.Insert($startPosition, $credsContent)
    $DSCContent += "O365TenantConfig -ConfigurationData .\ConfigurationData.psd1"
    #endregion

    #region Prompt the user for a location to save the extract and generate the files
    $OutputDSCPath = Read-Host "Destination Path"
    while (!(Test-Path -Path $OutputDSCPath -PathType Container -ErrorAction SilentlyContinue))
    {
        try
        {
            Write-Output "Directory `"$OutputDSCPath`" doesn't exist; creating..."
            New-Item -Path $OutputDSCPath -ItemType Directory | Out-Null
            if ($?) {break}
        }
        catch
        {
            Write-Warning "$($_.Exception.Message)"
            Write-Warning "Could not create folder $OutputDSCPath!"
        }
        $OutputDSCPath = Read-Host "Please Enter Output Folder for DSC Configuration (Will be Created as Necessary)"
    }
    <## Ensures the path we specify ends with a Slash, in order to make sure the resulting file path is properly structured. #>
    if (!$OutputDSCPath.EndsWith("\") -and !$OutputDSCPath.EndsWith("/"))
    {
        $OutputDSCPath += "\"
    }

    $outputDSCFile = $OutputDSCPath + "Office365TenantConfig.ps1"
    $DSCContent | Out-File $outputDSCFile

    if (!$AzureAutomation)
    {
        $outputConfigurationData = $OutputDSCPath + "ConfigurationData.psd1"
        New-ConfigurationDataDocument -Path $outputConfigurationData
    }
    #endregion
    Invoke-Item -Path $OutputDSCPath
}
